#!/usr/bin/env node
var sys = require('sys'),
  path = require('path'),
  fs = require('fs'),
  spawn = require('child_process').spawn,
  argv = require('optimist')
    .default('c', './cable')
    .argv

// need to make sure home/.deja exists

var home = process.env.HOME

// if HOME not set and not specified, die
if (home == undefined) {

  sys.puts('NOOOOO')
}

if (argv['_'].length < 1 || argv['_'].length > 2) {

  sys.puts('Wrong number of args.')
}
else if(argv['_'].length == 2) {

  var command = argv['_'][0]
  var param = argv['_'][1]

  if (command == 'clone') {

    var basename = path.basename(param)

    // add check to see if basename already exists
    // maybe username should be added to basename
    // or maybe basename should be MD5 of repo?
    // ..not a big deal whatever

    var destination = home + '/.deja/' + basename

    spawn('git', ['clone', param, destination])

    // cycle through cloned repo making symlinks to home, promping if files exist when the symlink would otherwise go
    children = fs.readdirSync(destination)

    for(var index in children) {

      var file = children[index]
      if (file != '.git') {

        var symlink = destination + '/' + file

        path.exists(symlink, function(exists) {

          if (!exists) {

sys.puts('LINKING')
            // do the link to the home directory
            spawn('ln', ['-s', symlink, file])
          }
          else {

            sys.puts('Already exists!')
          }
        })
      }
    }
  }

  sys.puts(argv['c'])
  sys.puts(argv['_'])
}
else {


}
